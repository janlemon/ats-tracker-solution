import{a as oe,s as me,r as t,v as ue,j as e,w,b as M,at as _,B as d,au as xe,m as q,L as V,ak as he,am as je,an as pe,ao as ge,ap as fe,aq as Ne,ar as ye,as as Ce,C as ve,c as be,d as Se,U as we,e as De,f as Te,o as ae,I as re,av as Ae,aw as ke,ax as G,ay as D,az as Re,aA as T,T as Pe,t as h,ai as A,O as Ue}from"./index-BElxQeur.js";import{L as k}from"./label-2xgWSV0F.js";import{B as Ee}from"./badge-C_6wi-kQ.js";import{D as B,a as H,b as Q,c as $,d as J,X as W,e as Y}from"./dialog-CKAHgLAD.js";import{C as Z}from"./checkbox-Bv92hGFs.js";import{S as Fe}from"./square-pen-B_Zwy85Y.js";const I=[{id:"Admin",label:"Admin",description:"Full system access"},{id:"Trader",label:"Trader",description:"Trading operations (exclusive - cannot combine with other roles)"},{id:"Compliance",label:"Compliance",description:"Compliance oversight"},{id:"Market Risk",label:"Market Risk",description:"Risk management"},{id:"IT",label:"IT",description:"IT support"},{id:"Committee",label:"Committee",description:"Committee member (cannot combine with Trader)"}];function Le({open:i,onOpenChange:l,title:N,onSelect:R}){const[o,y]=t.useState(""),[g,n]=t.useState([]),m=t.useRef(null),f=t.useCallback(a=>{if(y(a),m.current&&clearTimeout(m.current),a.length<2){n([]);return}m.current=setTimeout(async()=>{try{const u=await Ue.SearchUserV2(a,10);u.data&&Array.isArray(u.data.value)?n(u.data.value):n([])}catch(u){console.error("Search error:",u),n([])}},400)},[]),j=t.useCallback(()=>{y(""),n([]),l(!1)},[l]);return e.jsx(B,{open:i,onOpenChange:a=>{a?l(!0):j()},children:e.jsxs(H,{className:"sm:max-w-[425px]",children:[e.jsx(Q,{children:e.jsx($,{children:N})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ae,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(re,{placeholder:"Search person...",value:o,onChange:a=>f(a.target.value),className:"pl-9",autoFocus:!0})]}),e.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1",children:[g.length===0&&o.length>=2&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No users found."}),o.length<2&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Type at least 2 characters to search"}),g.map(a=>e.jsxs("div",{className:"flex flex-col p-3 hover:bg-muted rounded-md cursor-pointer border",onClick:()=>{R(a),j()},children:[e.jsx("span",{className:"font-medium",children:a.DisplayName}),e.jsx("span",{className:"text-sm text-muted-foreground",children:a.Mail})]},a.Id))]})]})]})})}function ee(i){if(!i)return"-";if(typeof i=="string")return i;if(typeof i=="object"&&i!==null){const l=i;if(l.DisplayName)return String(l.DisplayName);if(l.Email)return String(l.Email)}return"-"}function se(i){if(!i)return"";if(typeof i=="object"&&i!==null){const l=i;if(l.Email)return String(l.Email)}return""}function He(){const i=oe(),{isAdmin:l,isLoading:N}=me(),[R,o]=t.useState(!1),[y,g]=t.useState(!1),[n,m]=t.useState(null),[f,j]=t.useState(null),[a,u]=t.useState(""),[C,z]=t.useState("all"),[c,v]=t.useState(null),[p,P]=t.useState([]),{data:b,isLoading:ie}=ue({queryKey:["roles"],queryFn:async()=>(await A.getAll()).data||[]}),U=b?.filter(s=>{const r=ee(s.User)||s.Title||"",x=se(s.User)||"",O=s.Role?.Value||"",ce=a===""||r.toLowerCase().includes(a.toLowerCase())||x.toLowerCase().includes(a.toLowerCase()),de=C==="all"||O.includes(C);return ce&&de})||[];if(console.log("[AdminRolesPage] userRolesLoading:",N,"isAdmin:",l),N)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading user roles..."}),e.jsx(w,{className:"h-10 w-64"}),e.jsx(w,{className:"h-64 w-full"})]});const E=M({mutationFn:async s=>A.create(s),onSuccess:()=>{i.invalidateQueries({queryKey:["roles"]}),h.success("Permission added successfully"),L(),o(!1)},onError:s=>{console.error("Create error:",s),h.error("Error adding permission")}}),F=M({mutationFn:async({id:s,data:r})=>A.update(s,r),onSuccess:()=>{i.invalidateQueries({queryKey:["roles"]}),h.success("Permission updated successfully"),L(),m(null)},onError:s=>{console.error("Update error:",s),h.error("Error updating permission")}}),K=M({mutationFn:async s=>A.delete(s),onSuccess:()=>{i.invalidateQueries({queryKey:["roles"]}),h.success("Permission deleted successfully"),j(null)},onError:s=>{console.error("Delete error:",s),h.error("Error deleting permission")}}),L=()=>{v(null),P([])},le=s=>{v({Claims:`i:0#.f|membership|${s.UserPrincipalName}`,DisplayName:s.DisplayName,Email:s.Mail||s.UserPrincipalName})},X=()=>{if(!c){h.error("Please select a user");return}if(p.length===0){h.error("Please select at least one role");return}const s={Title:c.DisplayName,User:c,Role:{Value:p.join(", ")}};n?F.mutate({id:String(n.ID),data:s}):E.mutate(s)},te=s=>{m(s),v({Claims:s.User?.Claims||"",DisplayName:s.User?.DisplayName||s.Title||"",Email:s.User?.Email||""}),P(s.Role?.Value?s.Role.Value.split(", ").map(r=>r.trim()):[])},S=s=>{P(r=>s==="Trader"?r.includes("Trader")?r.filter(x=>x!=="Trader"):["Trader"]:s==="Committee"?r.includes("Committee")?r.filter(x=>x!=="Committee"):[...r.filter(O=>O!=="Trader"),"Committee"]:r.includes("Trader")?[s]:r.includes(s)?r.filter(x=>x!==s):[...r,s])},ne=()=>{L(),o(!0)};return ie?e.jsxs("div",{className:"space-y-6",children:[e.jsx(w,{className:"h-10 w-64"}),e.jsx(w,{className:"h-96"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(_,{className:"h-6 w-6"}),"User Permissions"]}),e.jsx("p",{className:"text-muted-foreground",children:"Manage user roles and access permissions"})]}),e.jsxs(d,{onClick:ne,children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Add Permission"]})]}),e.jsx(B,{open:R,onOpenChange:o,children:e.jsxs(H,{className:"sm:max-w-[500px]",children:[e.jsxs(Q,{children:[e.jsx($,{children:"Add New Permission"}),e.jsx(J,{children:"Select a user and assign roles to them."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"User *"}),e.jsxs(d,{variant:"outline",className:"w-full justify-start",onClick:()=>g(!0),children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),c?c.DisplayName:"Select user...",c&&e.jsx(W,{className:"ml-auto h-4 w-4 hover:text-red-500",onClick:s=>{s.stopPropagation(),v(null)}})]}),c&&e.jsx("p",{className:"text-sm text-muted-foreground",children:c.Email})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(k,{children:"Roles *"}),e.jsx("div",{className:"space-y-2",children:I.map(s=>e.jsxs("div",{className:`flex items-start space-x-3 p-3 rounded-lg border cursor-pointer transition-colors ${p.includes(s.id)?"bg-primary/5 border-primary":"hover:bg-muted"}`,onClick:()=>S(s.id),children:[e.jsx(Z,{id:s.id,checked:p.includes(s.id),onCheckedChange:()=>S(s.id)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:s.id,className:"text-sm font-medium cursor-pointer",children:s.label}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description})]})]},s.id))})]})]}),e.jsxs(Y,{children:[e.jsx(d,{variant:"outline",onClick:()=>o(!1),children:"Cancel"}),e.jsx(d,{onClick:X,disabled:E.isPending,children:E.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):"Add Permission"})]})]})}),e.jsx(Le,{open:y,onOpenChange:g,title:"Select User",onSelect:le}),e.jsx(B,{open:!!n,onOpenChange:s=>!s&&m(null),children:e.jsxs(H,{className:"sm:max-w-[500px]",children:[e.jsxs(Q,{children:[e.jsx($,{children:"Edit Permission"}),e.jsxs(J,{children:["Update roles for ",n?.Title,"."]})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"User"}),e.jsxs("div",{className:"flex items-center gap-2 p-3 border rounded-lg bg-muted/50",children:[e.jsx(q,{className:"h-4 w-4"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:c?.DisplayName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c?.Email})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(k,{children:"Roles *"}),e.jsx("div",{className:"space-y-2",children:I.map(s=>e.jsxs("div",{className:`flex items-start space-x-3 p-3 rounded-lg border cursor-pointer transition-colors ${p.includes(s.id)?"bg-primary/5 border-primary":"hover:bg-muted"}`,onClick:()=>S(s.id),children:[e.jsx(Z,{id:`edit-${s.id}`,checked:p.includes(s.id),onCheckedChange:()=>S(s.id)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:`edit-${s.id}`,className:"text-sm font-medium cursor-pointer",children:s.label}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description})]})]},s.id))})]})]}),e.jsxs(Y,{children:[e.jsx(d,{variant:"outline",onClick:()=>m(null),children:"Cancel"}),e.jsx(d,{onClick:X,disabled:F.isPending,children:F.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):"Save Changes"})]})]})}),e.jsx(he,{open:!!f,onOpenChange:s=>!s&&j(null),children:e.jsxs(je,{children:[e.jsxs(pe,{children:[e.jsx(ge,{children:"Delete Permission"}),e.jsx(fe,{children:"Are you sure you want to delete this permission? This action cannot be undone."})]}),e.jsxs(Ne,{children:[e.jsx(ye,{children:"Cancel"}),e.jsx(Ce,{className:"bg-red-500 hover:bg-red-600",onClick:()=>f&&K.mutate(f),children:K.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Deleting..."]}):"Delete"})]})]})}),e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsxs(Se,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"h-5 w-5"}),"Assigned Permissions"]}),e.jsx(De,{children:"List of users and their assigned roles in the system"})]}),e.jsxs(Te,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(ae,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(re,{placeholder:"Search by name or email...",value:a,onChange:s=>u(s.target.value),className:"pl-9"})]}),e.jsxs("select",{value:C,onChange:s=>z(s.target.value),className:"h-10 px-3 py-2 border rounded-md bg-background text-sm",children:[e.jsx("option",{value:"all",children:"All roles"}),I.map(s=>e.jsx("option",{value:s.id,children:s.label},s.id))]}),(a||C!=="all")&&e.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>{u(""),z("all")},children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"Clear"]}),e.jsxs("span",{className:"text-sm text-muted-foreground ml-auto",children:[U.length," of ",b?.length||0," users"]})]}),U.length>0?e.jsxs(Ae,{children:[e.jsx(ke,{children:e.jsxs(G,{children:[e.jsx(D,{children:"User"}),e.jsx(D,{children:"Email"}),e.jsx(D,{children:"Roles"}),e.jsx(D,{className:"text-right",children:"Actions"})]})}),e.jsx(Re,{children:U.map(s=>e.jsxs(G,{children:[e.jsx(T,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(q,{className:"h-4 w-4 text-primary"})}),ee(s.User)||s.Title]})}),e.jsx(T,{className:"text-muted-foreground",children:se(s.User)}),e.jsx(T,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:s.Role?.Value?.split(", ").map(r=>e.jsx(Ee,{variant:"secondary",children:r.trim()},r))})}),e.jsx(T,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-1",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>te(s),children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>j(String(s.ID)),children:e.jsx(Pe,{className:"h-4 w-4 text-red-500"})})]})})]},s.ID))})]}):e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(_,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),b&&b.length>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"font-medium",children:"No results found"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search or filter"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"font-medium",children:"No permissions assigned yet"}),e.jsx("p",{className:"text-sm",children:'Click "Add Permission" to assign roles to users'})]})]})]})]})]})}export{He as default};
