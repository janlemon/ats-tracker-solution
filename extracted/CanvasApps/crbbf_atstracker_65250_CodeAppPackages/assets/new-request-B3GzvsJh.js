import{u as te,a as ie,r as n,b as ne,j as e,B as j,C as k,c as D,d as R,e as I,f as L,I as y,S as le,g as oe,h as ce,i as de,k as me,l as ue,U as pe,F as he,L as V,t as B,m as F,A as xe,n as ge,O as je,o as ve}from"./index-BElxQeur.js";import{A as Z,B as Ne,T as h,P as W}from"./textarea-m8511rVK.js";import{L as i}from"./label-2xgWSV0F.js";import{X as $,D as Se,a as fe,b as be,c as Ce}from"./dialog-CKAHgLAD.js";import{P as Te,a as ye,b as Ae,C as we,S as Pe}from"./popover-DtRmaoja.js";import{C as ke}from"./calendar-_BWrpPnM.js";import{S as De}from"./send-C29nFcZr.js";function H({open:C,onOpenChange:T,title:r,onSelect:x}){const[a,d]=n.useState(""),[N,v]=n.useState([]),S=n.useRef(null),M=n.useCallback(l=>{if(d(l),S.current&&clearTimeout(S.current),l.length<2){v([]);return}S.current=setTimeout(async()=>{try{const g=await je.SearchUserV2(l,10);g.data&&Array.isArray(g.data.value)?v(g.data.value):v([])}catch(g){console.error("Search error:",g),v([])}},400)},[]),f=n.useCallback(()=>{d(""),v([]),T(!1)},[T]);return e.jsx(Se,{open:C,onOpenChange:l=>{l?T(!0):f()},children:e.jsxs(fe,{className:"sm:max-w-[425px]",children:[e.jsx(be,{children:e.jsx(Ce,{children:r})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ve,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(y,{placeholder:"Search person...",value:a,onChange:l=>M(l.target.value),className:"pl-9",autoFocus:!0})]}),e.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1",children:[N.length===0&&a.length>=2&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No users found."}),a.length<2&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Type at least 2 characters to search"}),N.map(l=>e.jsxs("div",{className:"flex flex-col p-3 hover:bg-muted rounded-md cursor-pointer border",onClick:()=>{x(l),f()},children:[e.jsx("span",{className:"font-medium",children:l.DisplayName}),e.jsx("span",{className:"text-sm text-muted-foreground",children:l.Mail})]},l.Id))]})]})]})})}const Re=["New","Modification"];function Ge(){const C=te(),T=ie(),[r,x]=n.useState({Title:"",ATSType:"",DeskName:"",BookName:"",FrontEnd:"",ProposedGoLiveDate:null,ExcelTradingScopeAttached:!1}),[a,d]=n.useState({ATSDescription:"",BacktestingDescription:"",RiskAndLimitsSummary:"",MessagingRateSummary:"",BusinessContinuityPlan:"",RecordKeepingArrangements:"",IPProtection:"",ConformanceTesting:"",PnLSplitRule:""}),[N,v]=n.useState(null),[S,M]=n.useState(null),[f,l]=n.useState(null),[g,Y]=n.useState([]),[E,Q]=n.useState([]),[O,X]=n.useState([]),[G,_]=n.useState([]),[z,A]=n.useState(null),[c,J]=n.useState({}),b=ne({mutationFn:async s=>(console.log("[NewRequest] Creating request with data:",s.data),ge.create(s.data)),onSuccess:async(s,t)=>{console.log("[NewRequest] Create result:",s);try{const m=s.data?.ID,o=s.data?.Title||r.Title||"New Request";if(m){const p=t.isDraft?`Draft "${o}" was created.`:`Request "${o}" was created and submitted for approval.`,u=t.isDraft?"Draft Created":"Request Submitted";await xe.create({Title:u,Message:p,ATSRequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:m,Value:o},MessageType:{Value:"System"},Department:{Value:"System"},Decision:{Value:"Info only"}}),console.log("[NewRequest] System message created")}}catch(m){console.error("[NewRequest] Failed to create system message:",m)}t.isDraft?B.success("Draft saved",{description:"You can continue editing later."}):B.success("Request submitted",{description:"Awaiting approval from Compliance, Market Risk, and IT."}),T.invalidateQueries({queryKey:["ats-requests"]}),C("/")},onError:s=>{console.error("[NewRequest] Create error:",s);const t=s?.message||s?.response?.data?.message||"Unknown error occurred";B.error("Failed to create request",{description:t})}}),ee=()=>{const s={};return r.Title.trim()||(s.Title="ATS Name is required"),r.ATSType||(s.ATSType="ATS Type is required"),a.ATSDescription.trim()||(s.ATSDescription="ATS Description is required"),N||(s.TraderSupervision="Trader (Constant Supervision) is required"),f||(s.ResponsiblePerson="Responsible Person is required"),J(s),Object.keys(s).length===0},w=s=>{if(s.length!==0)return s.map(t=>({Claims:t.Claims,DisplayName:t.DisplayName,Email:t.Email}))},K=s=>({Title:r.Title||"Untitled Draft",ATSType:r.ATSType?{Value:r.ATSType}:void 0,DeskName:r.DeskName||void 0,BookName:r.BookName||void 0,FrontEnd:r.FrontEnd||void 0,ProposedGoLiveDate:r.ProposedGoLiveDate?.toISOString(),ExcelTradingScopeAttached:r.ExcelTradingScopeAttached,ATSDescription:a.ATSDescription||void 0,BacktestingDescription:a.BacktestingDescription||void 0,RiskAndLimitsSummary:a.RiskAndLimitsSummary||void 0,MessagingRateSummary:a.MessagingRateSummary||void 0,BusinessContinuityPlan:a.BusinessContinuityPlan||void 0,RecordKeepingArrangements:a.RecordKeepingArrangements||void 0,IPProtection:a.IPProtection||void 0,ConformanceTesting:a.ConformanceTesting||void 0,PnLSplitRule:a.PnLSplitRule||void 0,TraderConstantSupervision:N||void 0,TraderBackup:S||void 0,ResponsiblePerson:f||void 0,ResponsiblePersonBackup:w(g),KillSwitchAuthorizedPersons:w(E),CriticalITAccess_RW:w(O),CriticalITAccess_R:w(G),SystemStatus:{Value:s}}),se=()=>{const s=K("Draft");console.log("[NewRequest] Saving as draft:",s),b.mutate({data:s,isDraft:!0})},ae=()=>{if(!ee()){const t=Object.keys(c).length;B.error("Validation failed",{description:`Please fill in ${t} required field${t>1?"s":""}`});return}const s=K("Submitted");console.log("[NewRequest] Submitting payload:",s),b.mutate({data:s,isDraft:!1})},U=s=>({Claims:`i:0#.f|membership|${s.UserPrincipalName}`,DisplayName:s.DisplayName,Email:s.Mail||s.UserPrincipalName}),q=({label:s,value:t,onChange:m,fieldKey:o,required:p=!1})=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs(i,{children:[s," ",p&&"*"]}),e.jsxs(j,{variant:"outline",className:`w-full justify-start ${c[o]?"border-red-500":""}`,onClick:()=>A(o),children:[e.jsx(F,{className:"mr-2 h-4 w-4"}),t?t.DisplayName:`Select ${s.toLowerCase()}...`,t&&e.jsx($,{className:"ml-auto h-4 w-4 hover:text-red-500",onClick:u=>{u.stopPropagation(),m(null)}})]}),e.jsx(H,{open:z===o,onOpenChange:u=>A(u?o:null),title:`Select ${s}`,onSelect:u=>m(U(u))}),c[o]&&e.jsx("p",{className:"text-sm text-red-500",children:c[o]})]}),P=({label:s,values:t,onChange:m,fieldKey:o})=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:s}),e.jsxs("div",{className:"space-y-2",children:[t.map((p,u)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx(F,{className:"h-4 w-4"}),e.jsx("span",{className:"flex-1",children:p.DisplayName}),e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>m(t.filter((Ie,re)=>re!==u)),children:e.jsx($,{className:"h-4 w-4"})})]},u)),e.jsxs(j,{variant:"outline",className:"w-full",onClick:()=>A(o),children:[e.jsx(F,{className:"mr-2 h-4 w-4"}),"Add person..."]}),e.jsx(H,{open:z===o,onOpenChange:p=>A(p?o:null),title:`Add ${s}`,onSelect:p=>m([...t,U(p)])})]})]});return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-xl bg-gradient-to-r from-[var(--ezpada-dark-grey)] to-[var(--ezpada-dark-red)] p-6 text-white shadow-lg",children:[e.jsx("div",{className:"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAxOGMtOS45NDEgMC0xOCA4LjA1OS0xOCAxOHM4LjA1OSAxOCAxOCAxOGM5Ljk0MSAwIDE4LTguMDU5IDE4LTE4cy04LjA1OS0xOC0xOC0xOHptMCAzMmMtNy43MzIgMC0xNC02LjI2OC0xNC0xNHM2LjI2OC0xNCAxNC0xNCAxNCA2LjI2OCAxNCAxNC02LjI2OCAxNC0xNCAxNHoiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iLjAzIi8+PC9nPjwvc3ZnPg==')] opacity-50"}),e.jsxs("div",{className:"relative flex items-center gap-4",children:[e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>C("/"),className:"text-white hover:bg-white/10",children:e.jsx(Z,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"New ATS Request"}),e.jsx("p",{className:"text-white/70 mt-1",children:"Fill in all required fields marked with *"})]}),e.jsx("div",{className:"hidden md:flex items-center gap-2 text-white/60 text-sm",children:e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/10",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-amber-400 animate-pulse"}),"Draft"]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(k,{className:"border-l-4 border-l-[var(--ezpada-red)] shadow-md hover:shadow-lg transition-shadow",children:[e.jsx(D,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-[var(--ezpada-red)]/10",children:e.jsx(Ne,{className:"h-5 w-5 text-[var(--ezpada-red)]"})}),e.jsxs("div",{children:[e.jsx(R,{className:"text-lg",children:"Basic Information"}),e.jsx(I,{children:"Main request details"})]})]})}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"title",children:"ATS Name *"}),e.jsx(y,{id:"title",value:r.Title,onChange:s=>x({...r,Title:s.target.value}),placeholder:"Enter ATS/Algorithm name",className:c.Title?"border-red-500":""}),c.Title&&e.jsx("p",{className:"text-sm text-red-500",children:c.Title})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"ATS Type *"}),e.jsxs(le,{value:r.ATSType,onValueChange:s=>x({...r,ATSType:s}),children:[e.jsx(oe,{className:c.ATSType?"border-red-500":"",children:e.jsx(ce,{placeholder:"Select type"})}),e.jsx(de,{children:Re.map(s=>e.jsx(me,{value:s,children:s},s))})]}),c.ATSType&&e.jsx("p",{className:"text-sm text-red-500",children:c.ATSType})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"deskName",children:"Desk Name"}),e.jsx(y,{id:"deskName",value:r.DeskName,onChange:s=>x({...r,DeskName:s.target.value}),placeholder:"Trading desk"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"bookName",children:"Book Name"}),e.jsx(y,{id:"bookName",value:r.BookName,onChange:s=>x({...r,BookName:s.target.value}),placeholder:"Trading book"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"frontEnd",children:"Front End"}),e.jsx(y,{id:"frontEnd",value:r.FrontEnd,onChange:s=>x({...r,FrontEnd:s.target.value}),placeholder:"Front-end system"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:"Proposed Go-Live Date"}),e.jsxs(Te,{children:[e.jsx(ye,{asChild:!0,children:e.jsxs(j,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),r.ProposedGoLiveDate?ue(r.ProposedGoLiveDate,"PPP"):"Select date"]})}),e.jsx(Ae,{className:"w-auto p-0",children:e.jsx(we,{mode:"single",selected:r.ProposedGoLiveDate||void 0,onSelect:s=>x({...r,ProposedGoLiveDate:s||null})})})]})]})]})]}),e.jsxs(k,{className:"border-l-4 border-l-blue-500 shadow-md hover:shadow-lg transition-shadow",children:[e.jsx(D,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-500/10",children:e.jsx(pe,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx(R,{className:"text-lg",children:"People"}),e.jsx(I,{children:"Responsible persons and access control"})]})]})}),e.jsxs(L,{className:"space-y-4",children:[e.jsx(q,{label:"Trader (Constant Supervision)",value:N,onChange:v,fieldKey:"TraderSupervision",required:!0}),e.jsx(q,{label:"Trader Backup",value:S,onChange:M,fieldKey:"TraderBackup"}),e.jsx(q,{label:"Responsible Person",value:f,onChange:l,fieldKey:"ResponsiblePerson",required:!0}),e.jsx(P,{label:"Responsible Person Backup",values:g,onChange:Y,fieldKey:"ResponsiblePersonBackup"}),e.jsx(P,{label:"Kill Switch Authorized Persons",values:E,onChange:Q,fieldKey:"KillSwitch"}),e.jsx(P,{label:"Critical IT Access (Read/Write)",values:O,onChange:X,fieldKey:"CriticalRW"}),e.jsx(P,{label:"Critical IT Access (Read Only)",values:G,onChange:_,fieldKey:"CriticalR"})]})]}),e.jsxs(k,{className:"lg:col-span-2 border-l-4 border-l-emerald-500 shadow-md hover:shadow-lg transition-shadow",children:[e.jsx(D,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-emerald-500/10",children:e.jsx(he,{className:"h-5 w-5 text-emerald-500"})}),e.jsxs("div",{children:[e.jsx(R,{className:"text-lg",children:"Descriptions & Documentation"}),e.jsx(I,{children:"Detailed information about the ATS"})]})]})}),e.jsxs(L,{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"atsDescription",className:"flex items-center gap-2",children:"ATS Description *"}),e.jsx(h,{id:"atsDescription",value:a.ATSDescription,onChange:s=>d({...a,ATSDescription:s.target.value}),placeholder:"Detailed description of the algorithmic trading system",rows:4,className:c.ATSDescription?"border-red-500":""}),c.ATSDescription&&e.jsx("p",{className:"text-sm text-red-500",children:c.ATSDescription})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"backtesting",children:"Backtesting Description"}),e.jsx(h,{id:"backtesting",value:a.BacktestingDescription,onChange:s=>d({...a,BacktestingDescription:s.target.value}),placeholder:"Description of backtesting methodology and results",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"riskLimits",children:"Risk and Limits Summary"}),e.jsx(h,{id:"riskLimits",value:a.RiskAndLimitsSummary,onChange:s=>d({...a,RiskAndLimitsSummary:s.target.value}),placeholder:"Summary of risk parameters and trading limits",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"messagingRate",children:"Messaging Rate Summary"}),e.jsx(h,{id:"messagingRate",value:a.MessagingRateSummary,onChange:s=>d({...a,MessagingRateSummary:s.target.value}),placeholder:"Expected messaging rates and order flow",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"businessContinuity",children:"Business Continuity Plan"}),e.jsx(h,{id:"businessContinuity",value:a.BusinessContinuityPlan,onChange:s=>d({...a,BusinessContinuityPlan:s.target.value}),placeholder:"Business continuity and disaster recovery procedures",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"recordKeeping",children:"Record Keeping Arrangements"}),e.jsx(h,{id:"recordKeeping",value:a.RecordKeepingArrangements,onChange:s=>d({...a,RecordKeepingArrangements:s.target.value}),placeholder:"Data retention and record keeping procedures",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"ipProtection",children:"IP Protection"}),e.jsx(h,{id:"ipProtection",value:a.IPProtection,onChange:s=>d({...a,IPProtection:s.target.value}),placeholder:"Intellectual property protection measures",rows:4})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"conformanceTesting",children:"Conformance Testing"}),e.jsx(h,{id:"conformanceTesting",value:a.ConformanceTesting,onChange:s=>d({...a,ConformanceTesting:s.target.value}),placeholder:"Conformance testing procedures and results",rows:4})]}),e.jsxs("div",{className:"space-y-2 lg:col-span-2",children:[e.jsx(i,{htmlFor:"pnlSplit",children:"P&L Split Rule"}),e.jsx(h,{id:"pnlSplit",value:a.PnLSplitRule,onChange:s=>d({...a,PnLSplitRule:s.target.value}),placeholder:"Profit and loss split rules",rows:3})]})]})]}),e.jsxs(k,{className:"lg:col-span-2 border-l-4 border-l-amber-500 shadow-md",children:[e.jsx(D,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-500/10",children:e.jsx(W,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx(R,{className:"text-lg",children:"Attachments"}),e.jsx(I,{children:"Supporting documents for this request"})]})]})}),e.jsx(L,{children:e.jsxs("div",{className:"p-4 bg-amber-50 dark:bg-amber-950/30 rounded-lg border border-amber-200 dark:border-amber-800/50 flex items-start gap-3",children:[e.jsx("div",{className:"p-1.5 rounded-full bg-amber-100 dark:bg-amber-900/50",children:e.jsx(W,{className:"h-4 w-4 text-amber-600 dark:text-amber-400"})}),e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300",children:[e.jsx("strong",{children:"Note:"})," Attachments can be added after creating the request. Once saved, you can edit the request and add attachments via SharePoint."]})]})})]})]}),e.jsx("div",{className:"sticky bottom-0 py-4 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80 border-t -mx-6 px-6 mt-8",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(j,{variant:"ghost",onClick:()=>C("/"),className:"text-muted-foreground",children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Back to Dashboard"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(j,{variant:"outline",onClick:se,disabled:b.isPending,className:"min-w-[140px]",children:b.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),"Save as Draft"]})}),e.jsx(j,{onClick:ae,disabled:b.isPending,className:"min-w-[160px] bg-[var(--ezpada-red)] hover:bg-[var(--ezpada-red-hover)]",children:b.isPending?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),"Submit Request"]})})]})]})})]})}export{Ge as default};
