import{p as ae,r as X,j as e,L as F,U as ut,m as Y,B as w,ag as de,l as Ae,t as q,a as He,v as me,b as se,ah as Ce,ai as pt,q as ht,u as gt,s as xt,w as le,x as vt,aj as ft,ak as Pe,al as Le,T as Ve,am as Ie,an as Be,ao as Ee,ap as $e,aq as Fe,ar as ze,as as Ke,C as U,c as W,d as H,f as O,A as G,F as jt,n as J}from"./index-BElxQeur.js";import{u as yt}from"./useCommitteeDelegations-DSsmd-3L.js";import{B as M}from"./badge-C_6wi-kQ.js";import{T as Re,A as bt,B as Ct,P as _e}from"./textarea-m8511rVK.js";import{L as Oe}from"./label-2xgWSV0F.js";import{X as ue,D as Ye,a as Ge,b as Je,c as Xe,d as Ze,e as et}from"./dialog-CKAHgLAD.js";import{E as Nt,g as wt}from"./AttachmentService-C8YzT5nu.js";import{S as Rt}from"./square-pen-B_Zwy85Y.js";import{C as At}from"./calendar-_BWrpPnM.js";import{S as St}from"./send-C29nFcZr.js";const Tt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Dt=ae("circle-check",Tt);const kt=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],qt=ae("clock",kt);const Mt=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Qe=ae("copy",Mt);const Pt=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],Ue=ae("message-square",Pt);const Lt=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],tt=ae("rotate-ccw",Lt);const Vt=[["path",{d:"M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z",key:"117uat"}],["path",{d:"M6 12h16",key:"s4cdu5"}]],It=ae("send-horizontal",Vt);function Bt(s){if(!s)return null;const n=new Date(s);if(!isNaN(n.getTime()))return n;const o={ledna:0,Ãºnora:1,bÅ™ezna:2,dubna:3,kvÄ›tna:4,Äervna:5,Äervence:6,srpna:7,zÃ¡Å™Ã­:8,Å™Ã­jna:9,listopadu:10,prosince:11},b=/(\d{1,2})\.\s*([a-zÃ¡Ã©Ã­Ã³ÃºÅ¯Ã½ÄÄÄ›ÅˆÅ™Å¡Å¥Å¾]+)\s+(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/i,u=s.match(b);if(u){const g=parseInt(u[1]),A=u[2].toLowerCase(),c=parseInt(u[3]),S=u[4]?parseInt(u[4]):0,y=u[5]?parseInt(u[5]):0;if(o[A]!==void 0)return new Date(c,o[A],g,S,y)}return null}function Et(s){if(!s)return"";try{const n=Bt(s);return n?Ae(n,"d MMM yyyy HH:mm"):s}catch{return s}}function $t({votes:s,committeeMembers:n,isLoading:o,allVoted:b,allApproved:u,anyRejected:g,pendingVoters:A,currentUserEmail:c,currentUserName:S,delegatedVotes:y,isCommitteeMember:P,onCastVote:I,canUserVoteForMember:B,disabled:T,disabledReason:D}){const[x,C]=X.useState({open:!1,member:null,action:"Approved",comment:"",isSubmitting:!1});let r="pending",l="bg-yellow-50 border-yellow-200",j="text-yellow-700";u?(r="approved",l="bg-green-50 border-green-200",j="text-green-700"):g?(r="rejected",l="bg-red-50 border-red-200",j="text-red-700"):s.length>0&&(r="voting",l="bg-blue-50 border-blue-200",j="text-blue-700");const h=(m,v)=>{C({open:!0,member:m,action:v,comment:"",isSubmitting:!1})},R=async()=>{if(!(!x.member||!c)){C(m=>({...m,isSubmitting:!0}));try{await I({committeeMemberEmail:x.member.email,decision:x.action,comment:x.comment,votedByEmail:c,votedByName:S||c}),q.success(`Vote recorded: ${x.action}`,{description:`Your vote for ${x.member.displayName} has been recorded.`}),C({open:!1,member:null,action:"Approved",comment:"",isSubmitting:!1})}catch(m){console.error("Vote error:",m),q.error("Failed to record vote",{description:m?.message||"Please try again later."}),C(v=>({...v,isSubmitting:!1}))}}},L=m=>s.find(v=>v.committeeMemberEmail.toLowerCase()===m.toLowerCase());return o?e.jsxs("div",{className:`p-4 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-medium",children:"Committee"}),e.jsx(F,{className:"h-4 w-4 animate-spin text-muted-foreground"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading committee votes..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`p-4 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-medium flex items-center gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),"Committee (",s.filter(m=>m.decision).length,"/",n.length," votes)"]}),e.jsxs("span",{className:`text-sm font-medium ${j}`,children:[r==="approved"&&"All Approved",r==="rejected"&&"Rejected",r==="voting"&&"Voting in progress",r==="pending"&&"Pending"]})]}),T&&D&&e.jsx("p",{className:"text-xs text-muted-foreground mb-3 italic",children:D}),e.jsxs("div",{className:"flex flex-wrap gap-1 mb-3",children:[n.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"No committee members found in Roles."}),u&&e.jsx(M,{className:"bg-green-100 text-green-800 border-green-300",children:"All committee members approved"}),g&&e.jsxs(M,{variant:"destructive",children:["Rejected by ",s.filter(m=>m.decision==="Rejected").length," member(s)"]})]}),e.jsx("div",{className:"space-y-2",children:n.map(m=>{const v=L(m.email),z=v&&v.decision!==null,ee=!T&&c&&B(c,m.email,y),pe=y.some(he=>he.delegatorEmail.toLowerCase()===m.email.toLowerCase()),ie=c?.toLowerCase()===m.email.toLowerCase();return e.jsxs("div",{className:`p-3 rounded-md border ${z?v.decision==="Approved"?"bg-green-50/50 border-green-200":"bg-red-50/50 border-red-200":"bg-white/50 border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(Y,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium text-sm",children:m.displayName}),ie&&P&&e.jsx(M,{variant:"outline",className:"text-xs",children:"You"}),pe&&!ie&&e.jsx(M,{variant:"outline",className:"text-xs bg-purple-50 text-purple-700 border-purple-200",children:"Delegated to you"})]}),z&&e.jsx(M,{className:v.decision==="Approved"?"bg-green-100 text-green-800 border-green-300":"bg-red-100 text-red-800 border-red-300",children:v.decision}),!z&&!ee&&e.jsx(M,{variant:"secondary",className:"text-xs",children:"Pending"})]}),!z&&ee&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs(w,{size:"sm",variant:"outline",className:"h-7 px-3 text-xs bg-green-50 border-green-300 text-green-700 hover:bg-green-100",onClick:()=>h(m,"Approved"),children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"Approve"]}),e.jsxs(w,{size:"sm",variant:"outline",className:"h-7 px-3 text-xs bg-red-50 border-red-300 text-red-700 hover:bg-red-100",onClick:()=>h(m,"Rejected"),children:[e.jsx(ue,{className:"h-3 w-3 mr-1"}),"Reject"]})]}),z&&e.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[v.votedByEmail&&v.votedByEmail!==v.committeeMemberEmail&&e.jsxs("p",{children:["Voted by: ",v.votedByName||v.votedByEmail," (delegate)"]}),v.modified&&e.jsxs("p",{children:["Date: ",Et(v.modified)]}),v.comment&&e.jsxs("p",{className:"mt-1 italic",children:['"',v.comment,'"']})]})]},m.email)})}),n.length>0&&!b&&!g&&e.jsx("div",{className:"mt-3 pt-3 border-t",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:[A.length," vote(s) remaining: ",A.map(m=>m.displayName).join(", ")]})})]}),e.jsx(Ye,{open:x.open,onOpenChange:m=>{m||C({open:!1,member:null,action:"Approved",comment:"",isSubmitting:!1})},children:e.jsxs(Ge,{children:[e.jsxs(Je,{children:[e.jsxs(Xe,{children:[x.action==="Approved"?"Approve":"Reject"," Request"]}),e.jsx(Ze,{children:x.member&&e.jsxs(e.Fragment,{children:["Casting vote for ",e.jsx("strong",{children:x.member.displayName}),x.member.email.toLowerCase()!==c?.toLowerCase()&&e.jsx("span",{className:"text-purple-600",children:" (as delegate)"})]})})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(Oe,{children:"Comment (optional)"}),e.jsx(Re,{value:x.comment,onChange:m=>C(v=>({...v,comment:m.target.value})),placeholder:"Add a comment for your vote...",rows:3})]})}),e.jsxs(et,{children:[e.jsx(w,{variant:"outline",onClick:()=>C({open:!1,member:null,action:"Approved",comment:"",isSubmitting:!1}),disabled:x.isSubmitting,children:"Cancel"}),e.jsxs(w,{onClick:R,disabled:x.isSubmitting,className:x.action==="Approved"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700",children:[x.isSubmitting?e.jsx(F,{className:"h-4 w-4 mr-2 animate-spin"}):x.action==="Approved"?e.jsx(de,{className:"h-4 w-4 mr-2"}):e.jsx(ue,{className:"h-4 w-4 mr-2"}),x.action==="Approved"?"Approve":"Reject"]})]})]})})]})}function Ne(s){if(!s)return null;const o=(s.Claims||"").match(/\|([^|]+)$/);return o?o[1].toLowerCase():s.Email?.toLowerCase()||null}function Ft(s){const n=He(),{data:o=[],isLoading:b}=me({queryKey:["committee-members"],queryFn:async()=>{const l=(await pt.getAll()).data||[],j=[];for(const h of l)if((h.Role?.Value||"").toLowerCase().includes("committee")){const L=h.User,m=Ne(L);m&&j.push({email:m,displayName:L?.DisplayName||m,claims:L?.Claims||""})}return j},staleTime:300*1e3,enabled:s!==null}),{data:u=[],isLoading:g,error:A}=me({queryKey:["committee-approvals",s],queryFn:async()=>s?((await Ce.getAll({filter:`atsrequest/Id eq ${s}`})).data||[]).map(h=>({ID:h.ID||0,committeeMemberEmail:Ne(h.committeemember)||"",committeeMemberName:h.committeemember?.DisplayName||"",votedByEmail:Ne(h.votedby),votedByName:h.votedby?.DisplayName||null,decision:h.decision?.Value,comment:h.comment||null,created:h.Created||null,modified:h.Modified||null})):[],staleTime:30*1e3,enabled:s!==null}),c=se({mutationFn:async r=>{const l=u.find(R=>R.committeeMemberEmail.toLowerCase()===r.committeeMemberEmail.toLowerCase()),j=o.find(R=>R.email.toLowerCase()===r.committeeMemberEmail.toLowerCase()),h={Title:`Vote: ${r.requestTitle} - ${j?.displayName||r.committeeMemberEmail}`,atsrequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:r.requestId,Value:r.requestTitle},committeemember:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedUser",Claims:j?.claims||`i:0#.f|membership|${r.committeeMemberEmail}`,DisplayName:j?.displayName||r.committeeMemberEmail,Email:r.committeeMemberEmail,Picture:"",Department:"",JobTitle:""},votedby:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedUser",Claims:`i:0#.f|membership|${r.votedByEmail}`,DisplayName:r.votedByName,Email:r.votedByEmail,Picture:"",Department:"",JobTitle:""},decision:{Value:r.decision},comment:r.comment||""};l&&l.ID?await Ce.update(l.ID.toString(),h):await Ce.create(h)},onSuccess:()=>{n.invalidateQueries({queryKey:["committee-approvals",s]})}}),S=u,y=S.filter(r=>o.some(l=>l.email.toLowerCase()===r.committeeMemberEmail.toLowerCase())),P=o.length>0&&o.every(r=>y.some(l=>l.committeeMemberEmail.toLowerCase()===r.email.toLowerCase()&&l.decision!==null)),I=P&&y.filter(r=>o.some(l=>l.email.toLowerCase()===r.committeeMemberEmail.toLowerCase())).every(r=>r.decision==="Approved"),B=y.some(r=>r.decision==="Rejected"&&o.some(l=>l.email.toLowerCase()===r.committeeMemberEmail.toLowerCase())),T=P||B,D=o.filter(r=>!y.some(l=>l.committeeMemberEmail.toLowerCase()===r.email.toLowerCase()&&l.decision!==null)),x=r=>S.find(l=>l.committeeMemberEmail.toLowerCase()===r.toLowerCase())||null,C=(r,l,j)=>{if(!r||!l)return!1;const h=r.toLowerCase(),R=l.toLowerCase();return h===R?!0:j.some(L=>L.delegatorEmail.toLowerCase()===R)};return{votes:S,committeeMembers:o,isLoading:b||g,error:A,allVoted:P,allApproved:I,anyRejected:B,votingComplete:T,pendingVoters:D,castVote:c.mutateAsync,getVoteForMember:x,canUserVoteForMember:C}}function Z(s){if(!s)return"-";if(typeof s=="string")return s;if(typeof s=="object"&&s!==null){const n=s;if(n.DisplayName)return String(n.DisplayName);if(n.Email)return String(n.Email)}return"-"}function ce(s){if(!s)return"-";if(Array.isArray(s)){const n=s.map(o=>{if(typeof o=="string")return o;if(typeof o=="object"&&o!==null){const b=o;return b.DisplayName||b.Email||null}return null}).filter(Boolean);return n.length>0?n.join(", "):"-"}return Z(s)}function N(s){if(!s)return"";if(typeof s=="string")return s;if(typeof s=="object"&&s!==null){const n=s;if(n.Value)return String(n.Value)}return""}function st(s){if(!s)return null;const n=new Date(s);if(!isNaN(n.getTime()))return n;const o={ledna:0,Ãºnora:1,bÅ™ezna:2,dubna:3,kvÄ›tna:4,Äervna:5,Äervence:6,srpna:7,zÃ¡Å™Ã­:8,Å™Ã­jna:9,listopadu:10,prosince:11},b=/(\d{1,2})\.\s*([a-zÃ¡Ã©Ã­Ã³ÃºÅ¯Ã½ÄÄÄ›ÅˆÅ™Å¡Å¥Å¾]+)\s+(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/i,u=s.match(b);if(u){const g=parseInt(u[1]),A=u[2].toLowerCase(),c=parseInt(u[3]),S=u[4]?parseInt(u[4]):0,y=u[5]?parseInt(u[5]):0;if(o[A]!==void 0)return new Date(c,o[A],g,S,y)}return null}function We(s){if(!s)return"-";try{const n=st(s);return n?Ae(n,"d MMM yyyy"):s}catch{return s}}function re(s){if(!s)return"-";try{const n=st(s);return n?Ae(n,"d MMM yyyy HH:mm"):s}catch{return s}}function zt({status:s}){if(!s)return e.jsx(M,{variant:"secondary",children:"-"});const n=s.toLowerCase();return n.includes("approved")?e.jsx(M,{className:"bg-green-100 text-green-800 border-green-300",children:"Approved"}):n.includes("rejected")?e.jsx(M,{variant:"destructive",children:"Rejected"}):n.includes("pending")?e.jsx(M,{className:"bg-yellow-100 text-yellow-800 border-yellow-300",children:"Pending"}):n.includes("submitted")?e.jsx(M,{className:"bg-blue-100 text-blue-800 border-blue-300",children:"Submitted"}):n.includes("draft")?e.jsx(M,{variant:"secondary",children:"Draft"}):e.jsx(M,{variant:"outline",children:s})}function we({title:s,status:n,approvedBy:o,approvalDate:b,onApprove:u,onReject:g,onRequestChanges:A,isUpdating:c,disabled:S,disabledReason:y,canUserApprove:P}){const I=N(n),B=I.toLowerCase(),T=B.includes("approved"),D=B.includes("rejected"),x=B.includes("pending"),C=B.includes("changesrequested"),r=!T&&!D&&!C;let l="bg-gray-50 border-gray-200";T&&(l="bg-green-50 border-green-200"),D&&(l="bg-red-50 border-red-200"),x&&(l="bg-yellow-50 border-yellow-200"),C&&(l="bg-orange-50 border-orange-200");let j="text-gray-500";T&&(j="text-green-700"),D&&(j="text-red-700"),x&&(j="text-yellow-700"),C&&(j="text-orange-700");const h=Z(o),R=b?re(b):null;return e.jsxs("div",{className:`p-4 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-medium",children:s}),e.jsxs("span",{className:`text-sm font-medium ${j}`,children:[T&&"Approved",D&&"Rejected",x&&"Pending",C&&"Changes Requested",!I&&"Not started"]})]}),(T||D||C)&&h!=="-"&&e.jsxs("div",{className:"text-xs text-muted-foreground mb-2",children:[e.jsxs("span",{children:[T?"Approved":D?"Rejected":"Changes requested"," by: ",h]}),R&&e.jsxs("span",{children:[" â€¢ ",R]})]}),r&&!S&&P&&e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs(w,{size:"sm",className:"bg-green-600 hover:bg-green-700",onClick:u,disabled:c,children:[c?e.jsx(F,{className:"h-4 w-4 animate-spin"}):e.jsx(de,{className:"h-4 w-4 mr-1"}),"Approve"]}),A&&e.jsxs(w,{size:"sm",variant:"outline",className:"border-orange-300 text-orange-700 hover:bg-orange-50",onClick:A,disabled:c,children:[c?e.jsx(F,{className:"h-4 w-4 animate-spin"}):e.jsx(tt,{className:"h-4 w-4 mr-1"}),"Request Changes"]}),e.jsxs(w,{size:"sm",variant:"destructive",onClick:g,disabled:c,children:[c?e.jsx(F,{className:"h-4 w-4 animate-spin"}):e.jsx(ue,{className:"h-4 w-4 mr-1"}),"Reject"]})]}),r&&!S&&!P&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2 italic",children:["You don't have permission to approve for ",s]}),r&&S&&y&&e.jsx("p",{className:"text-xs text-muted-foreground mt-2 italic",children:y})]})}function V({label:s,value:n,icon:o}){return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[o&&e.jsx(o,{className:"h-3 w-3"}),s]}),e.jsx("div",{className:"bg-muted/50 rounded-md p-3",children:e.jsx("p",{className:"font-medium",children:n||"-"})})]})}function Kt(s){const n=g=>g?typeof g=="string"?g.toLowerCase():g?.Value?g.Value.toLowerCase():"":"",o=n(s.ComplianceStatus),b=n(s.MarketRiskStatus),u=n(s.ITStatus);return o.includes("rejected")||b.includes("rejected")||u.includes("rejected")}function Zt(){const{id:s}=ht(),n=gt(),o=He(),{canApproveForDepartment:b,isAdmin:u,currentUserEmail:g,currentUserName:A,hasRole:c}=xt(),{getDelegatedVotesFor:S}=yt();c("Trader")&&!u&&!c("Compliance")&&!c("MarketRisk")&&!c("IT")&&c("Committee");const y=g?S(g):[];c("Committee")||y.length>0;const P=c("Committee"),[I,B]=X.useState("self");X.useEffect(()=>{!P&&y.length>0&&I==="self"&&B(y[0].delegatorEmail)},[P,y,I]);const[T,D]=X.useState(""),[x,C]=X.useState(null),[r,l]=X.useState({open:!1,dept:"",action:"Approved",comment:""}),j=()=>c("Committee")?"Committee":c("Compliance")?"Compliance":c("MarketRisk")||c("Market Risk")?"Market Risk":c("IT")?"IT":c("Trader")?"Trader":"General",h=s?parseInt(s):null,{votes:R,committeeMembers:L,isLoading:m,allVoted:v,allApproved:z,anyRejected:ee,pendingVoters:pe,castVote:ie,canUserVoteForMember:he}=Ft(h),{data:t,isLoading:at,error:rt}=me({queryKey:["request",s],queryFn:async()=>{if(!s)throw new Error("No ID provided");const a=await J.get(s);if(!a.data)throw new Error("Request not found");return a.data},enabled:!!s});X.useEffect(()=>{(async()=>{if(!s||!t)return;const i=N(t.CommitteeStatus).toLowerCase();if(!(i==="approved"||i==="rejected")){if(v&&L.length>0){const d=z?"Approved":"Rejected";try{const f={CommitteeStatus:{Value:d},CommitteeDecisionDate:new Date().toISOString()};d==="Approved"?f.SystemStatus={Value:"Approved"}:f.SystemStatus={Value:"Rejected"},await J.update(s,f);const p=R.map(k=>`${k.committeeMemberName}: ${k.decision}`).join(", ");await G.create({Title:`Committee Final Decision: ${d}`,Message:`All committee members have voted. Final decision: ${d}.

Vote summary: ${p}`,MessageType:{Value:d==="Approved"?"Approval":"Rejection"},Department:{Value:"Committee"},Decision:{Value:d},ATSRequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:parseInt(s),Value:t?.Title||""}}),o.invalidateQueries({queryKey:["request",s]}),o.invalidateQueries({queryKey:["ats-requests"]}),o.invalidateQueries({queryKey:["messages",s]}),q.success(`Committee decision: ${d}`,{description:d==="Approved"?"All committee members approved. Request is now fully approved!":"Committee rejected the request."})}catch(f){console.error("Failed to update committee status:",f)}}if(ee&&!v&&N(t.CommitteeStatus).toLowerCase()!=="rejected")try{await J.update(s,{CommitteeStatus:{Value:"Rejected"},CommitteeDecisionDate:new Date().toISOString(),SystemStatus:{Value:"Rejected"}}),o.invalidateQueries({queryKey:["request",s]}),o.invalidateQueries({queryKey:["ats-requests"]}),q.error("Committee rejected the request")}catch(f){console.error("Failed to update rejection status:",f)}}})()},[v,z,ee,R,L,s,t,o]);const{data:K,isLoading:it}=me({queryKey:["messages",s],queryFn:async()=>{const i=(await G.getAll()).data||[],d=parseInt(s||"0");return i.filter(f=>(f.ATSRequest?.Id||f["ATSRequest#Id"])===d)},enabled:!!s}),nt=se({mutationFn:async({dept:a,status:i,comment:d,delegatedFor:f})=>{if(!s)throw new Error("No ID");const p={},k=new Date().toISOString(),$=g?{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedUser",Claims:`i:0#.f|membership|${g}`,DisplayName:"",Email:g}:void 0;switch(i==="ChangesRequested"&&(p.SystemStatus={Value:"ChangesRequested"}),a){case"Compliance":p.ComplianceStatus={Value:i},p.ComplianceDecisionDate=k,$&&(p.ComplianceBy=$);break;case"Market Risk":p.MarketRiskStatus={Value:i},p.MarketRiskDecisionDate=k,$&&(p.MarketRiskBy=$);break;case"IT":p.ITStatus={Value:i},p.ITDecisionDate=k,$&&(p.ITBy=$);break;case"Committee":p.CommitteeStatus={Value:i},p.CommitteeDecisionDate=k,i==="Approved"?p.SystemStatus={Value:"Approved"}:i==="Rejected"&&(p.SystemStatus={Value:"Rejected"});break}await J.update(s,p);const _=i==="Approved"?"Approval":i==="Rejected"?"Rejection":"Change Request",te=i;let Q;return a==="Committee"?f?Q=`Committee ${i.toLowerCase()} this request. Vote cast by ${f.delegateName.split("@")[0]} on behalf of ${f.delegatorName}.${i==="Approved"?" Final status: Approved":""}`:Q=`Committee ${i.toLowerCase()} this request.${i==="Approved"?" Final status: Approved":""}`:i==="ChangesRequested"?Q=`${a} department requested changes. The request has been returned to Draft status for the trader to edit.`:Q=`${a} department ${i.toLowerCase()} this request.`,d&&d.trim()&&(Q+=`

Comment: ${d.trim()}`),await G.create({Title:`${a} ${i==="ChangesRequested"?"Changes Requested":i}`,Message:Q,MessageType:{Value:_},Department:{Value:a==="Market Risk"?"Market Risk":a},Decision:{Value:te},ATSRequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:parseInt(s),Value:t?.Title||""}}),{dept:a,status:i}},onSuccess:(a,i)=>{o.invalidateQueries({queryKey:["request",s]}),o.invalidateQueries({queryKey:["ats-requests"]}),o.invalidateQueries({queryKey:["messages",s]});let d=`Request has been approved by ${i.dept} department.`;i.status==="Rejected"?d=`Request has been rejected by ${i.dept} department.`:i.status==="ChangesRequested"&&(d="Request has been returned to Draft status. The trader can now edit and resubmit."),q.success(`${i.dept} decision recorded`,{description:d}),C(null)},onError:(a,i)=>{console.error("Approval error:",a);const d=a?.message||"Please try again later";q.error(`Failed to update ${i.dept} status`,{description:d}),C(null)}}),ge=se({mutationFn:async()=>{const a={Title:`Message for ATS #${s}`,Message:T,MessageType:{Value:"Comment"},Department:{Value:j()},Decision:{Value:"Info only"},ATSRequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:parseInt(s||"0"),Value:t?.Title||""}};return G.create(a)},onSuccess:()=>{o.invalidateQueries({queryKey:["messages",s]}),D(""),q.success("Message sent",{description:"Your comment has been added to the discussion."})},onError:a=>{console.error("Message error:",a);const i=a?.message||"Please try again later";q.error("Failed to send message",{description:i})}}),xe=se({mutationFn:async()=>{if(!s)throw new Error("No ID");const a=[];if((!t?.Title||t.Title==="Untitled Draft")&&a.push("ATS Name"),N(t?.ATSType)||a.push("ATS Type"),t?.ATSDescription?.trim()||a.push("ATS Description"),t?.TraderConstantSupervision||a.push("Trader (Constant Supervision)"),t?.ResponsiblePerson||a.push("Responsible Person"),a.length>0)throw new Error(`Please fill in required fields: ${a.join(", ")}`);const d=N(t?.ComplianceStatus).toLowerCase(),f=N(t?.MarketRiskStatus).toLowerCase(),p=N(t?.ITStatus).toLowerCase(),k={SystemStatus:{Value:"Submitted"}};(d==="changesrequested"||d==="pending"||!d)&&(k.ComplianceStatus={Value:"Pending"}),(f==="changesrequested"||f==="pending"||!f)&&(k.MarketRiskStatus={Value:"Pending"}),(p==="changesrequested"||p==="pending"||!p)&&(k.ITStatus={Value:"Pending"}),await J.update(s,k);const $=d==="changesrequested"||f==="changesrequested"||p==="changesrequested";await G.create({Title:$?"Request Resubmitted":"Request Submitted",Message:$?"Request has been updated and resubmitted for review. Previously approved departments retain their approval.":"Request has been submitted for departmental review. Awaiting approval from Compliance, Market Risk, and IT.",MessageType:{Value:"System"},Department:{Value:"Trader"},Decision:{Value:"Info only"},ATSRequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:parseInt(s),Value:t?.Title||""}})},onSuccess:()=>{o.invalidateQueries({queryKey:["request",s]}),o.invalidateQueries({queryKey:["ats-requests"]}),o.invalidateQueries({queryKey:["messages",s]}),q.success("Request submitted",{description:"Awaiting approval from Compliance, Market Risk, and IT departments."})},onError:a=>{console.error("Submit error:",a);const i=a?.message||"Please try again later";q.error("Failed to submit request",{description:i})}}),Se=se({mutationFn:async()=>{if(!s)throw new Error("No ID");return J.delete(s)},onSuccess:()=>{o.invalidateQueries({queryKey:["ats-requests"]}),q.success("Request deleted",{description:"The draft request has been permanently removed."}),n("/")},onError:a=>{console.error("Delete error:",a);const i=a?.message||"Please try again later";q.error("Failed to delete request",{description:i})}}),Te=se({mutationFn:async()=>{if(!s||!t)throw new Error("No request to duplicate");const a={Title:`${t.Title||"ATS Request"} (Copy)`,ATSType:t.ATSType?{Value:N(t.ATSType)}:void 0,DeskName:t.DeskName||void 0,BookName:t.BookName||void 0,FrontEnd:t.FrontEnd||void 0,AlgoName:t.AlgoName||void 0,ProposedGoLiveDate:t.ProposedGoLiveDate||void 0,ExcelTradingScopeAttached:t.ExcelTradingScopeAttached||!1,ATSDescription:t.ATSDescription||void 0,BacktestingDescription:t.BacktestingDescription||void 0,RiskAndLimitsSummary:t.RiskAndLimitsSummary||void 0,MessagingRateSummary:t.MessagingRateSummary||void 0,BusinessContinuityPlan:t.BusinessContinuityPlan||void 0,RecordKeepingArrangements:t.RecordKeepingArrangements||void 0,IPProtection:t.IPProtection||void 0,ConformanceTesting:t.ConformanceTesting||void 0,PnLSplitRule:t.PnLSplitRule||void 0,TraderConstantSupervision:t.TraderConstantSupervision||void 0,TraderBackup:t.TraderBackup||void 0,ResponsiblePerson:t.ResponsiblePerson||void 0,ResponsiblePersonBackup:t.ResponsiblePersonBackup||void 0,KillSwitchAuthorizedPersons:t.KillSwitchAuthorizedPersons||void 0,CriticalITAccess_RW:t.CriticalITAccess_RW||void 0,CriticalITAccess_R:t.CriticalITAccess_R||void 0,SystemStatus:{Value:"Draft"},ComplianceStatus:void 0,ITStatus:void 0,MarketRiskStatus:void 0,CommitteeStatus:void 0,ComplianceDecisionDate:void 0,ITDecisionDate:void 0,MarketRiskDecisionDate:void 0,CommitteeDecisionDate:void 0,ComplianceBy:void 0,ITBy:void 0,MarketRiskBy:void 0},i=await J.create(a);return i.data?.ID&&await G.create({Title:"Request Duplicated",Message:`This request was duplicated from "${t.Title}" (ID: ${t.ID}). All values have been copied, status set to Draft.`,MessageType:{Value:"System"},Department:{Value:"System"},Decision:{Value:"Info only"},ATSRequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:i.data.ID,Value:i.data.Title||""}}),i},onSuccess:a=>{o.invalidateQueries({queryKey:["ats-requests"]}),q.success("Request duplicated",{description:"A copy has been created as a Draft. You can now edit it."}),a.data?.ID&&n(`/request/${a.data.ID}`)},onError:a=>{console.error("Duplicate error:",a);const i=a?.message||"Please try again later";q.error("Failed to duplicate request",{description:i})}}),ve=a=>{l({open:!0,dept:a,action:"Approved",comment:""})},fe=a=>{l({open:!0,dept:a,action:"Rejected",comment:""})},je=a=>{l({open:!0,dept:a,action:"ChangesRequested",comment:""})},ot=()=>{C(r.dept);const a=r.dept==="Committee"&&I!=="self"?y.find(i=>i.delegatorEmail===I):void 0;nt.mutate({dept:r.dept,status:r.action,comment:r.comment,delegatedFor:a?{delegatorEmail:a.delegatorEmail,delegatorName:a.delegatorName,delegateName:g||""}:void 0}),l({open:!1,dept:"",action:"Approved",comment:""})};if(at)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(le,{className:"h-10 w-64"}),e.jsx(le,{className:"h-6 w-96"}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsx(le,{className:"h-64"}),e.jsx(le,{className:"h-64"})]})]});if(rt||!t)return e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(vt,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Request not found"}),e.jsxs("p",{className:"text-muted-foreground mb-4",children:["ID: ",s]}),e.jsx(w,{onClick:()=>n("/"),children:"Back to list"})]});const De=N(t.ATSType),ne=N(t.SystemStatus),lt=ft(t),ye=Kt(t),ke=N(t.ComplianceStatus).toLowerCase(),qe=N(t.MarketRiskStatus).toLowerCase(),Me=N(t.ITStatus).toLowerCase(),oe=ke==="changesrequested"||qe==="changesrequested"||Me==="changesrequested",E=!ne||ne.toLowerCase()==="draft",ct=ne.toLowerCase()==="changesrequested",dt=t.Author?.Claims?.toLowerCase()||"",mt=g&&dt.includes(g.toLowerCase()),be=u||(E||ct)&&mt;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(w,{variant:"outline",size:"sm",onClick:()=>n("/"),children:[e.jsx(bt,{className:"h-4 w-4 mr-2"}),"Back to List"]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-bold",children:t.Title||`ATS-${t.ID}`}),e.jsx(zt,{status:ne})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Trader:"})," ",Z(t.TraderConstantSupervision)]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Type:"})," ",De||"-"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Created:"})," ",We(t.Created)]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[E&&be&&e.jsxs(w,{variant:"default",className:"bg-blue-600 hover:bg-blue-700",onClick:()=>xe.mutate(),disabled:xe.isPending,children:[xe.isPending?e.jsx(F,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(It,{className:"h-4 w-4 mr-2"}),"Submit for Approval"]}),be&&e.jsxs(w,{onClick:()=>n(`/edit/${t.ID}`),children:[e.jsx(Rt,{className:"h-4 w-4 mr-2"}),"Edit Request"]}),E&&be&&e.jsxs(Pe,{children:[e.jsx(Le,{asChild:!0,children:e.jsxs(w,{variant:"destructive",children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Delete"]})}),e.jsxs(Ie,{children:[e.jsxs(Be,{children:[e.jsx(Ee,{children:"Delete Request"}),e.jsx($e,{children:"Are you sure you want to delete this request? This action cannot be undone."})]}),e.jsxs(Fe,{children:[e.jsx(ze,{children:"Cancel"}),e.jsxs(Ke,{onClick:()=>Se.mutate(),className:"bg-red-600 hover:bg-red-700",children:[Se.isPending?e.jsx(F,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})]}),e.jsxs(Pe,{children:[e.jsx(Le,{asChild:!0,children:e.jsxs(w,{variant:"outline",children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"Duplicate"]})}),e.jsxs(Ie,{children:[e.jsxs(Be,{children:[e.jsx(Ee,{children:"Duplicate Request"}),e.jsx($e,{children:"This will create a copy of this request with all values. The new request will be in Draft status, ready for you to edit and submit for approval."})]}),e.jsxs(Fe,{children:[e.jsx(ze,{children:"Cancel"}),e.jsxs(Ke,{onClick:()=>Te.mutate(),className:"bg-blue-600 hover:bg-blue-700",children:[Te.isPending?e.jsx(F,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"Create Copy"]})]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs(U,{children:[e.jsx(W,{children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(Dt,{className:"h-5 w-5"}),"Approval Status"]})}),e.jsxs(O,{className:"space-y-3",children:[oe&&e.jsxs("div",{className:"p-3 bg-orange-50 border border-orange-200 rounded-lg mb-2",children:[e.jsx("p",{className:"text-sm text-orange-700 font-medium",children:"Waiting for Trader"}),e.jsx("p",{className:"text-xs text-orange-600",children:"A department has requested changes. Approvals are blocked until the trader updates and resubmits the request."})]}),e.jsx(we,{title:"Compliance",status:t.ComplianceStatus,approvedBy:t.ComplianceBy,approvalDate:t.ComplianceDecisionDate,onApprove:()=>ve("Compliance"),onReject:()=>fe("Compliance"),onRequestChanges:()=>je("Compliance"),isUpdating:x==="Compliance",canUserApprove:b("Compliance"),disabled:E||oe&&ke!=="changesrequested",disabledReason:E?"Request must be submitted first":"Another department requested changes. Wait for trader to resubmit."}),e.jsx(we,{title:"Market Risk",status:t.MarketRiskStatus,approvedBy:t.MarketRiskBy,approvalDate:t.MarketRiskDecisionDate,onApprove:()=>ve("Market Risk"),onReject:()=>fe("Market Risk"),onRequestChanges:()=>je("Market Risk"),isUpdating:x==="Market Risk",canUserApprove:b("Market Risk"),disabled:E||oe&&qe!=="changesrequested",disabledReason:E?"Request must be submitted first":"Another department requested changes. Wait for trader to resubmit."}),e.jsx(we,{title:"IT",status:t.ITStatus,approvedBy:t.ITBy,approvalDate:t.ITDecisionDate,onApprove:()=>ve("IT"),onReject:()=>fe("IT"),onRequestChanges:()=>je("IT"),isUpdating:x==="IT",canUserApprove:b("IT"),disabled:E||oe&&Me!=="changesrequested",disabledReason:E?"Request must be submitted first":"Another department requested changes. Wait for trader to resubmit."}),e.jsxs("div",{className:"border-t pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2 font-medium",children:"Final Approval"}),ye&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg mb-3",children:[e.jsx("p",{className:"text-sm text-red-700 font-medium",children:"Cannot proceed to Committee"}),e.jsx("p",{className:"text-xs text-red-600",children:"One or more departments rejected this request."})]}),e.jsx($t,{votes:R,committeeMembers:L,isLoading:m,allVoted:v,allApproved:z,anyRejected:ee,pendingVoters:pe,currentUserEmail:g,currentUserName:A||g?.split("@")[0]||null,delegatedVotes:y,isCommitteeMember:P,onCastVote:async a=>{await ie({...a,requestId:h,requestTitle:t?.Title||`ATS-${h}`}),await G.create({Title:`Committee Vote: ${a.decision}`,Message:a.committeeMemberEmail===a.votedByEmail?`${a.votedByName} voted: ${a.decision}${a.comment?`. Comment: ${a.comment}`:""}`:`${a.votedByName} voted ${a.decision} on behalf of ${L.find(i=>i.email===a.committeeMemberEmail)?.displayName||a.committeeMemberEmail}${a.comment?`. Comment: ${a.comment}`:""}`,MessageType:{Value:a.decision==="Approved"?"Approval":"Rejection"},Department:{Value:"Committee"},Decision:{Value:a.decision},ATSRequest:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedReference",Id:h,Value:t?.Title||""}}),o.invalidateQueries({queryKey:["messages",s]}),o.invalidateQueries({queryKey:["committee-approvals",h]})},canUserVoteForMember:he,disabled:E||!lt||ye,disabledReason:E?"Request must be submitted first":ye?"Request was rejected by a department":"All departments must approve first"})]})]})]}),e.jsxs(U,{children:[e.jsx(W,{children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(qt,{className:"h-5 w-5"}),"Timeline"]})}),e.jsxs(O,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-green-500 mt-1.5 shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-sm",children:"Request Created"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:re(t.Created)})]})]}),K&&K.filter(a=>{const i=N(a.MessageType);return i==="System"||i==="Approval"||i==="Rejection"||i==="Change Request"}).sort((a,i)=>new Date(a.Created).getTime()-new Date(i.Created).getTime()).map(a=>{const i=N(a.MessageType),d=N(a.Decision),f=N(a.Department);let p="bg-blue-500";return(d==="Approved"||i==="Approval")&&(p="bg-green-500"),(d==="Rejected"||i==="Rejection")&&(p="bg-red-500"),(d==="Changes Requested"||i==="Change Request")&&(p="bg-amber-500"),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full ${p} mt-1.5 shrink-0`}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-sm",children:a.Title}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[f&&e.jsx("span",{className:"mr-2",children:f}),re(a.Created)]})]})]},a.ID)}),t.Modified&&t.Modified!==t.Created&&(!K||K.length===0)&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-blue-500 mt-1.5 shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-sm",children:"Last Modified"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:re(t.Modified)})]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(U,{children:[e.jsx(W,{children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(jt,{className:"h-5 w-5"}),"Request Information"]})}),e.jsxs(O,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(V,{label:"ATS Type",value:De,icon:Ct}),e.jsx(V,{label:"Trader",value:Z(t.TraderConstantSupervision),icon:Y}),e.jsx(V,{label:"Trader Backup",value:Z(t.TraderBackup),icon:Y}),e.jsx(V,{label:"Responsible Person",value:Z(t.ResponsiblePerson),icon:Y}),e.jsx(V,{label:"Desk Name",value:t.DeskName}),e.jsx(V,{label:"Book Name",value:t.BookName}),e.jsx(V,{label:"Front End",value:t.FrontEnd}),e.jsx(V,{label:"Proposed Go-Live Date",value:We(t.ProposedGoLiveDate),icon:At})]}),t.ATSDescription&&e.jsxs("div",{className:"mt-4 pt-4 border-t",children:[e.jsx("h4",{className:"font-medium mb-2",children:"ATS Description"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.ATSDescription})]})]})]}),(t.BacktestingDescription||t.RiskAndLimitsSummary||t.MessagingRateSummary||t.ConformanceTesting)&&e.jsxs(U,{children:[e.jsx(W,{children:e.jsx(H,{children:"Technical Details"})}),e.jsxs(O,{className:"space-y-4",children:[t.BacktestingDescription&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"Backtesting Description"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.BacktestingDescription})]}),t.RiskAndLimitsSummary&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"Risk and Limits Summary"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.RiskAndLimitsSummary})]}),t.MessagingRateSummary&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"Messaging Rate Summary"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.MessagingRateSummary})]}),t.ConformanceTesting&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"Conformance Testing"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.ConformanceTesting})]})]})]}),(t.BusinessContinuityPlan||t.RecordKeepingArrangements||t.IPProtection||t.PnLSplitRule)&&e.jsxs(U,{children:[e.jsx(W,{children:e.jsx(H,{children:"Business Continuity & Compliance"})}),e.jsxs(O,{className:"space-y-4",children:[t.BusinessContinuityPlan&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"Business Continuity Plan"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.BusinessContinuityPlan})]}),t.RecordKeepingArrangements&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"Record Keeping Arrangements"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.RecordKeepingArrangements})]}),t.IPProtection&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"IP Protection"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.IPProtection})]}),t.PnLSplitRule&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:"P&L Split Rule"}),e.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-wrap",children:t.PnLSplitRule})]})]})]}),(t.KillSwitchAuthorizedPersons||t.CriticalITAccess_RW||t.CriticalITAccess_R||t.ResponsiblePersonBackup)&&e.jsxs(U,{children:[e.jsx(W,{children:e.jsx(H,{children:"Access Control"})}),e.jsx(O,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(V,{label:"Kill Switch Authorized",value:ce(t.KillSwitchAuthorizedPersons),icon:Y}),e.jsx(V,{label:"Critical IT Access (RW)",value:ce(t.CriticalITAccess_RW),icon:Y}),e.jsx(V,{label:"Critical IT Access (R)",value:ce(t.CriticalITAccess_R),icon:Y}),e.jsx(V,{label:"Responsible Person Backup",value:ce(t.ResponsiblePersonBackup),icon:Y})]})})]}),e.jsxs(U,{children:[e.jsx(W,{className:"flex flex-row items-center justify-between",children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-5 w-5"}),"Attachments"]})}),e.jsx(O,{children:e.jsxs("div",{className:"text-center py-6 space-y-4",children:[e.jsx(_e,{className:"h-10 w-10 mx-auto text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage attachments directly in SharePoint"}),s&&e.jsxs(w,{variant:"default",onClick:()=>window.open(wt(parseInt(s)),"_blank"),children:[e.jsx(Nt,{className:"h-4 w-4 mr-2"}),"Add/Edit Attachments"]})]})})]}),e.jsxs(U,{children:[e.jsx(W,{children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"h-5 w-5"}),"Messages (",K?.length||0,")"]})}),e.jsxs(O,{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 space-y-4 bg-muted/30",children:[e.jsx(Re,{placeholder:"Write your message...",value:T,onChange:a=>D(a.target.value),rows:3}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Posting as: ",e.jsx("span",{className:"font-medium",children:j()})]}),e.jsxs(w,{onClick:()=>ge.mutate(),disabled:ge.isPending||!T.trim(),children:[ge.isPending?e.jsx(F,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(St,{className:"h-4 w-4 mr-2"}),"Send Message"]})]})]}),it?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(F,{className:"h-6 w-6 animate-spin"})}):K&&K.length>0?e.jsx("div",{className:"space-y-4",children:[...K].sort((a,i)=>new Date(i.Created).getTime()-new Date(a.Created).getTime()).map(a=>{const i=N(a.Department)||"",d=N(a.MessageType)||"Comment",f=Z(a.Author)||"Unknown",p=f.split(" ").map(Q=>Q[0]).join("").toUpperCase().slice(0,2),k=()=>{switch(i){case"Compliance":return{borderColor:"var(--dept-compliance)",bgColor:"var(--dept-compliance)",lightBg:"var(--dept-compliance-light)",badgeBg:"var(--dept-compliance-light)",badgeText:"var(--dept-compliance)"};case"Market Risk":return{borderColor:"var(--dept-marketrisk)",bgColor:"var(--dept-marketrisk)",lightBg:"var(--dept-marketrisk-light)",badgeBg:"var(--dept-marketrisk-light)",badgeText:"var(--dept-marketrisk)"};case"IT":return{borderColor:"var(--dept-it)",bgColor:"var(--dept-it)",lightBg:"var(--dept-it-light)",badgeBg:"var(--dept-it-light)",badgeText:"var(--dept-it)"};case"Committee":return{borderColor:"var(--dept-committee)",bgColor:"var(--dept-committee)",lightBg:"var(--dept-committee-light)",badgeBg:"var(--dept-committee-light)",badgeText:"var(--dept-committee)"};case"Trader":return{borderColor:"var(--dept-trader)",bgColor:"var(--dept-trader)",lightBg:"var(--dept-trader-light)",badgeBg:"var(--dept-trader-light)",badgeText:"var(--dept-trader)"};case"System":return{borderColor:"var(--dept-system)",bgColor:"var(--dept-system)",lightBg:"var(--dept-system-light)",badgeBg:"var(--dept-system-light)",badgeText:"var(--dept-system)"};default:return{borderColor:"var(--ats-border)",bgColor:"var(--ats-text-muted)",lightBg:"var(--ats-surface)",badgeBg:"var(--ats-surface)",badgeText:"var(--ats-text-muted)"}}},$=()=>{switch(d){case"Approval":return{bg:"var(--msg-approval-light)",text:"var(--msg-approval)",icon:"âœ“"};case"Rejection":return{bg:"var(--msg-rejection-light)",text:"var(--msg-rejection)",icon:"âœ•"};case"Change Request":return{bg:"var(--msg-change-light)",text:"var(--msg-change)",icon:"â†»"};case"System":return{bg:"var(--dept-system-light)",text:"var(--dept-system)",icon:"â—"};default:return{bg:"var(--msg-comment-light)",text:"var(--ats-text-secondary)",icon:"ðŸ’¬"}}},_=k(),te=$();return e.jsx("div",{className:"rounded-xl border overflow-hidden transition-all hover:shadow-md",style:{borderLeftWidth:"4px",borderLeftColor:_.borderColor,backgroundColor:_.lightBg},children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-10 h-10 min-w-[40px] rounded-full flex items-center justify-center text-white font-semibold text-sm shadow-sm",style:{backgroundColor:_.bgColor},children:d==="System"?"âš™":p}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-2",children:[e.jsx("span",{className:"font-semibold text-sm",style:{color:"var(--ats-text)"},children:f}),e.jsxs("span",{className:"text-xs font-medium px-2 py-0.5 rounded-full border",style:{backgroundColor:te.bg,color:te.text,borderColor:te.text+"40"},children:[te.icon," ",d]}),e.jsx("span",{className:"text-xs font-medium px-2 py-0.5 rounded-full border",style:{backgroundColor:_.badgeBg,color:_.badgeText,borderColor:_.badgeText+"40"},children:i||"General"}),e.jsx("span",{className:"text-xs ml-auto",style:{color:"var(--ats-text-muted)"},children:re(a.Created)})]}),e.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-wrap",style:{color:"var(--ats-text-secondary)"},children:a.Message})]})]})})},a.ID)})}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Ue,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No messages yet"})]})]})]})]})]}),e.jsx(Ye,{open:r.open,onOpenChange:a=>{a||l({open:!1,dept:"",action:"Approved",comment:""})},children:e.jsxs(Ge,{className:"sm:max-w-[425px]",children:[e.jsxs(Je,{children:[e.jsxs(Xe,{children:[r.action==="Approved"&&`Approve - ${r.dept}`,r.action==="Rejected"&&`Reject - ${r.dept}`,r.action==="ChangesRequested"&&`Request Changes - ${r.dept}`]}),e.jsxs(Ze,{children:[r.action==="Approved"&&"You are about to approve this request. Add an optional comment below.",r.action==="Rejected"&&"You are about to reject this request. Please provide a reason.",r.action==="ChangesRequested"&&"You are requesting changes. Please describe what needs to be updated."]})]}),e.jsxs("div",{className:"py-4",children:[e.jsxs(Oe,{htmlFor:"approval-comment",className:"mb-2 block",children:["Comment ",r.action!=="Approved"&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Re,{id:"approval-comment",placeholder:r.action==="Approved"?"Optional comment...":r.action==="Rejected"?"Please explain why this request is being rejected...":"Please describe what changes are needed...",value:r.comment,onChange:a=>l({...r,comment:a.target.value}),rows:4,className:"resize-none"})]}),e.jsxs(et,{children:[e.jsx(w,{variant:"outline",onClick:()=>l({open:!1,dept:"",action:"Approved",comment:""}),children:"Cancel"}),e.jsxs(w,{variant:r.action==="Approved"?"default":r.action==="Rejected"?"destructive":"secondary",onClick:ot,disabled:(r.action==="Rejected"||r.action==="ChangesRequested")&&!r.comment.trim(),children:[r.action==="Approved"&&e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Approve"]}),r.action==="Rejected"&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Reject"]}),r.action==="ChangesRequested"&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{className:"w-4 h-4 mr-2"}),"Request Changes"]})]})]})]})})]})}export{Zt as default};
