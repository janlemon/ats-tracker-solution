import{p as oe,a as ye,s as Ce,r as i,l as H,j as e,w as F,b as $,U as Y,B as N,au as we,C as Z,f as ee,m as I,I as Q,aB as be,L as se,ak as Se,am as Ae,an as Pe,ao as ke,ap as Te,aq as Ee,ar as Ue,as as Me,c as Fe,d as Ie,e as Le,av as Ve,aw as Oe,ax as te,ay as w,az as Re,aA as b,ag as ze,T as $e,t as p,aC as q,O as qe,o as Be}from"./index-BElxQeur.js";import{u as He}from"./useCommitteeDelegations-DSsmd-3L.js";import{L}from"./label-2xgWSV0F.js";import{B}from"./badge-C_6wi-kQ.js";import{D as ce,a as de,b as me,c as he,d as Qe,X as ae,e as _e}from"./dialog-CKAHgLAD.js";import{C as Ke}from"./checkbox-Bv92hGFs.js";import{C as re}from"./calendar-_BWrpPnM.js";const Xe=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],le=oe("arrow-right",Xe);const Ge=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],Je=oe("info",Ge);function We(r){if(!r)return null;const c=new Date(r);if(!isNaN(c.getTime()))return c;const n={ledna:0,února:1,března:2,dubna:3,května:4,června:5,července:6,srpna:7,září:8,října:9,listopadu:10,prosince:11},S=/(\d{1,2})\.\s*([a-záéíóúůýčďěňřšťž]+)\s+(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/i,o=r.match(S);if(o){const h=parseInt(o[1]),f=o[2].toLowerCase(),v=parseInt(o[3]),x=o[4]?parseInt(o[4]):0,j=o[5]?parseInt(o[5]):0;if(n[f]!==void 0)return new Date(v,n[f],h,x,j)}return null}function ne(r){if(!r)return"—";try{const c=We(r);return c?H(c,"d MMM yyyy"):r}catch{return r}}function m(r){if(!r)return null;const n=(r.Claims||"").match(/\|([^|]+)$/);return n?n[1].toLowerCase():r.Email?.toLowerCase()||null}function ie({open:r,onOpenChange:c,title:n,onSelect:S,excludeEmails:o=[]}){const[h,f]=i.useState(""),[v,x]=i.useState([]),j=i.useRef(null),A=i.useCallback(t=>{if(f(t),j.current&&clearTimeout(j.current),t.length<2){x([]);return}j.current=setTimeout(async()=>{try{const g=await qe.SearchUserV2(t,10);if(g.data&&Array.isArray(g.data.value)){const l=g.data.value.filter(y=>!o.includes(y.Mail?.toLowerCase()||"")&&!o.includes(y.UserPrincipalName?.toLowerCase()||""));x(l)}else x([])}catch(g){console.error("Search error:",g),x([])}},400)},[o]),D=i.useCallback(()=>{f(""),x([]),c(!1)},[c]);return e.jsx(ce,{open:r,onOpenChange:t=>{t?c(!0):D()},children:e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsx(me,{children:e.jsx(he,{children:n})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Be,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(Q,{placeholder:"Search person...",value:h,onChange:t=>A(t.target.value),className:"pl-9",autoFocus:!0})]}),e.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1",children:[v.length===0&&h.length>=2&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No users found."}),h.length<2&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Type at least 2 characters to search"}),v.map(t=>e.jsxs("div",{className:"flex flex-col p-3 hover:bg-muted rounded-md cursor-pointer border",onClick:()=>{S(t),D()},children:[e.jsx("span",{className:"font-medium",children:t.DisplayName}),e.jsx("span",{className:"text-sm text-muted-foreground",children:t.Mail})]},t.Id))]})]})]})})}function cs(){const r=ye(),{isLoading:c}=Ce(),{delegations:n,isLoading:S}=He(),[o,h]=i.useState(!1),[f,v]=i.useState(!1),[x,j]=i.useState(!1),[A,D]=i.useState(null),[t,g]=i.useState(null),[l,y]=i.useState(null),[V,_]=i.useState(!0),[P,K]=i.useState(H(new Date,"yyyy-MM-dd")),[T,X]=i.useState(""),[O,C]=i.useState([]),xe=S;if(c)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading user roles..."}),e.jsx(F,{className:"h-10 w-64"}),e.jsx(F,{className:"h-64 w-full"})]});const R=(s,a,E)=>{const u=[];if(!s||!a)return u;const k=m(s),U=m(a);return!k||!U?(u.push("Invalid user selection"),u):(k===U&&u.push("A person cannot delegate to themselves"),E.filter(d=>m(d.Delegator)===k&&d.Active).length>0&&u.push(`${s.DisplayName} already has an active delegation. Remove it first.`),E.find(d=>m(d.Delegator)===U&&d.Active)&&u.push(`${a.DisplayName} has already delegated their vote. They cannot receive delegations.`),E.find(d=>m(d.Delegate)===k&&d.Active)&&u.push(`${s.DisplayName} is receiving delegations from others. They cannot delegate their vote.`),E.find(d=>{const M=m(d.Delegator),De=m(d.Delegate);return M===U&&De===k&&d.Active})&&u.push("Circular delegation detected. The delegate already delegates to this person."),u)},z=$({mutationFn:async()=>{if(!t||!l)throw new Error("Missing data");console.log("[Delegations] Creating delegation:",{delegator:t,delegate:l,isActive:V,validFrom:P,validTo:T});const s=await q.create({Delegator:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedUser",Claims:t.Claims,DisplayName:t.DisplayName,Email:t.Email},Delegate:{"@odata.type":"#Microsoft.Azure.Connectors.SharePoint.SPListExpandedUser",Claims:l.Claims,DisplayName:l.DisplayName,Email:l.Email},Active:V,ValidFrom:P?new Date(P).toISOString():new Date().toISOString(),ValidTo:T?new Date(T).toISOString():void 0});if(console.log("[Delegations] Create result:",s),s.error)throw new Error(s.error.message||"Failed to create delegation");return s.data},onSuccess:s=>{console.log("[Delegations] Create success:",s),r.invalidateQueries({queryKey:["committee-delegations"]}),p.success("Delegation created successfully"),W(),h(!1)},onError:s=>{console.error("[Delegations] Create error:",s);const a=s?.message||s?.toString()||"Unknown error";p.error("Error creating delegation",{description:a})}}),G=$({mutationFn:async s=>q.delete(s.toString()),onSuccess:()=>{r.invalidateQueries({queryKey:["committee-delegations"]}),p.success("Delegation removed successfully"),D(null)},onError:s=>{console.error("Delete error:",s),p.error("Error removing delegation")}}),J=$({mutationFn:async({id:s,active:a})=>q.update(s.toString(),{Active:a}),onSuccess:()=>{r.invalidateQueries({queryKey:["committee-delegations"]}),p.success("Delegation updated")},onError:s=>{console.error("Update error:",s),p.error("Error updating delegation")}}),W=()=>{g(null),y(null),_(!0),K(H(new Date,"yyyy-MM-dd")),X(""),C([])},ge=s=>{const a={Claims:`i:0#.f|membership|${s.UserPrincipalName}`,DisplayName:s.DisplayName,Email:s.Mail||s.UserPrincipalName};g(a),C(R(a,l,n))},ue=s=>{const a={Claims:`i:0#.f|membership|${s.UserPrincipalName}`,DisplayName:s.DisplayName,Email:s.Mail||s.UserPrincipalName};y(a),C(R(t,a,n))},pe=()=>{if(!t){p.error("Please select a delegator (who is delegating)");return}if(!l){p.error("Please select a delegate (who will vote)");return}const s=R(t,l,n);if(s.length>0){C(s),p.error("Cannot create delegation",{description:s[0]});return}z.mutate()},je=()=>{W(),h(!0)},fe=()=>t?[m(t)||""]:[],ve=()=>l?[m(l)||""]:[],Ne=s=>{if(!s.Active)return!1;const a=new Date;return!(s.ValidFrom&&new Date(s.ValidFrom)>a||s.ValidTo&&new Date(s.ValidTo)<a)};return xe?e.jsxs("div",{className:"space-y-6",children:[e.jsx(F,{className:"h-10 w-64"}),e.jsx(F,{className:"h-96"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Y,{className:"h-6 w-6"}),"Committee Vote Delegations"]}),e.jsx("p",{className:"text-muted-foreground",children:"Manage vote delegations for Committee members"})]}),e.jsxs(N,{onClick:je,children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Add Delegation"]})]}),e.jsx(Z,{className:"bg-blue-50 border-blue-200",children:e.jsx(ee,{className:"pt-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Je,{className:"h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Delegation Rules:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-blue-700",children:[e.jsx("li",{children:"A Committee member can delegate their vote to another person"}),e.jsx("li",{children:"Each person can only delegate to ONE other person"}),e.jsx("li",{children:"A delegate cannot further delegate votes they receive"}),e.jsx("li",{children:"The original member can still vote themselves (delegation doesn't remove their vote)"}),e.jsx("li",{children:"Valid To date is optional - leave empty for indefinite delegation"})]})]})]})})}),e.jsx(ce,{open:o,onOpenChange:h,children:e.jsxs(de,{className:"sm:max-w-[500px]",children:[e.jsxs(me,{children:[e.jsx(he,{children:"Add New Delegation"}),e.jsx(Qe,{children:"Select who is delegating their vote and to whom."})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Delegator (who is delegating) *"}),e.jsxs(N,{variant:"outline",className:"w-full justify-start",onClick:()=>v(!0),children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),t?t.DisplayName:"Select Committee member...",t&&e.jsx(ae,{className:"ml-auto h-4 w-4 hover:text-red-500",onClick:s=>{s.stopPropagation(),g(null),C([])}})]}),t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t.Email})]}),e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("span",{className:"text-sm",children:"delegates to"}),e.jsx(le,{className:"h-4 w-4"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Delegate (who will vote) *"}),e.jsxs(N,{variant:"outline",className:"w-full justify-start",onClick:()=>j(!0),children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),l?l.DisplayName:"Select person...",l&&e.jsx(ae,{className:"ml-auto h-4 w-4 hover:text-red-500",onClick:s=>{s.stopPropagation(),y(null),C([])}})]}),l&&e.jsx("p",{className:"text-sm text-muted-foreground",children:l.Email})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Valid From *"}),e.jsx(Q,{type:"date",value:P,onChange:s=>K(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Valid To (optional)"}),e.jsx(Q,{type:"date",value:T,onChange:s=>X(s.target.value),min:P}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Leave empty for indefinite"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ke,{id:"active",checked:V,onCheckedChange:s=>_(s)}),e.jsx("label",{htmlFor:"active",className:"text-sm font-medium cursor-pointer",children:"Active immediately"})]}),O.length>0&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(be,{className:"h-4 w-4 text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-700",children:"Cannot create delegation:"}),e.jsx("ul",{className:"text-sm text-red-600 list-disc list-inside",children:O.map((s,a)=>e.jsx("li",{children:s},a))})]})]})})]}),e.jsxs(_e,{children:[e.jsx(N,{variant:"outline",onClick:()=>h(!1),children:"Cancel"}),e.jsx(N,{onClick:pe,disabled:z.isPending||O.length>0,children:z.isPending?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating..."]}):"Create Delegation"})]})]})}),e.jsx(ie,{open:f,onOpenChange:v,title:"Select Delegator",onSelect:ge,excludeEmails:ve()}),e.jsx(ie,{open:x,onOpenChange:j,title:"Select Delegate",onSelect:ue,excludeEmails:fe()}),e.jsx(Se,{open:A!==null,onOpenChange:()=>D(null),children:e.jsxs(Ae,{children:[e.jsxs(Pe,{children:[e.jsx(ke,{children:"Remove Delegation?"}),e.jsx(Te,{children:"This will permanently remove this vote delegation. The delegator will need to vote themselves or create a new delegation."})]}),e.jsxs(Ee,{children:[e.jsx(Ue,{children:"Cancel"}),e.jsx(Me,{className:"bg-red-500 hover:bg-red-600",onClick:()=>A&&G.mutate(A),children:G.isPending?e.jsx(se,{className:"h-4 w-4 animate-spin"}):"Remove"})]})]})}),e.jsxs(Z,{children:[e.jsxs(Fe,{children:[e.jsx(Ie,{children:"Current Delegations"}),e.jsxs(Le,{children:[n.length," delegation",n.length!==1?"s":""," configured"]})]}),e.jsx(ee,{children:n.length>0?e.jsxs(Ve,{children:[e.jsx(Oe,{children:e.jsxs(te,{children:[e.jsx(w,{children:"Delegator"}),e.jsx(w,{}),e.jsx(w,{children:"Delegate"}),e.jsx(w,{children:"Valid Period"}),e.jsx(w,{children:"Status"}),e.jsx(w,{className:"text-right",children:"Actions"})]})}),e.jsx(Re,{children:n.map(s=>{const a=Ne(s);return e.jsxs(te,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(I,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.Delegator?.DisplayName||"Unknown"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:m(s.Delegator)})]})]})}),e.jsx(b,{children:e.jsx(le,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-green-100 flex items-center justify-center",children:e.jsx(I,{className:"h-4 w-4 text-green-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.Delegate?.DisplayName||"Unknown"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:m(s.Delegate)})]})]})}),e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(re,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{children:ne(s.ValidFrom)}),e.jsx("span",{className:"text-muted-foreground",children:"→"}),e.jsx("span",{children:s.ValidTo?ne(s.ValidTo):"∞"})]})}),e.jsx(b,{children:a?e.jsxs(B,{className:"bg-green-100 text-green-700 hover:bg-green-100",children:[e.jsx(ze,{className:"h-3 w-3 mr-1"}),"Active"]}):s.Active?e.jsxs(B,{variant:"secondary",children:[e.jsx(re,{className:"h-3 w-3 mr-1"}),"Scheduled"]}):e.jsx(B,{variant:"outline",className:"text-muted-foreground",children:"Inactive"})}),e.jsx(b,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-1",children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>J.mutate({id:s.ID,active:!s.Active}),disabled:J.isPending,children:s.Active?"Deactivate":"Activate"}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>D(s.ID),children:e.jsx($e,{className:"h-4 w-4 text-red-500"})})]})})]},s.ID)})})]}):e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Y,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"font-medium",children:"No delegations configured"}),e.jsx("p",{className:"text-sm",children:'Click "Add Delegation" to allow someone to vote on behalf of another'})]})})]})]})}export{cs as default};
